---
version: "2.0"
name: "opensds.migration-bucket"

workflows:

    main:
        type: direct
        input:
            - osds_ip
            - osds_port
            - osds_tenant_id
            - userId
            - name
            - description
            - destBackend
            - srcBucketName
            - destBucketName
            - remainSource
            - osds_token
        output:
            tagline: "<% $.print_status %>"
        task-defaults:
          on-error:
            - fail
        tasks:
            get_bucket:
                action: opensds.get-bucket
                input:
                    url: "http://<% $.osds_ip %>:<% $.osds_port %>/v1/s3/"
                    bucket_name: "<% $.destBucketName %>"
                    osds_token: '<% $.osds_token %>'
                publish:
                    print_status: <% task(get_bucket).result.stdout %>
                on-success:
                    - create_bucket_migration
                on-error:
                    - create_bucket
            create_bucket:
                action: opensds.create-bucket
                input:
                    url: "http://<% $.osds_ip %>:<% $.osds_port %>/v1/s3/<% $.destBucketName %>"
                    backend_name: "<% $.destBackend %>"
                    osds_token: '<% $.osds_token %>'
                publish:
                    print_status: <% task(create_bucket).result.stdout %>
                on-success:
                    - create_bucket_migration
            create_bucket_migration:
                action: opensds.create-bucket-migration
                input:
                    url: "http://<% $.osds_ip %>:<% $.osds_port %>/v1/<% $.osds_tenant_id %>/plans"
                    osds_tenant_id: "<% $.osds_tenant_id %>"
                    user_id: "<% $.userId %>"
                    name: "<% $.name%>"
                    description: "<% $.description %>"
                    src_bucket_name: "<% $.srcBucketName %>"
                    dest_bucket_name: "<% $.destBucketName %>"
                    remain_source: "<% $.remainSource %>"
                    osds_token: '<% $.osds_token %>'
                publish:
                    migrationId: <% task(create_bucket_migration).result.result %>
                on-success:
                    - execute_bucket_migration
            execute_bucket_migration:
                action: opensds.execute-bucket-migration
                input:
                    url: "http://<% $.osds_ip %>:<% $.osds_port %>/v1/<% $.osds_tenant_id %>/plans/<% $.migrationId %>/run"
                    osds_token: '<% $.osds_token %>'
                publish:
                    jobId : <% task(execute_bucket_migration).result.result %>
                on-success:
                    - get_bucket_migration
            get_bucket_migration:
                action: opensds.get-bucket-migration
                input:
                    url: "http://<% $.osds_ip %>:<% $.osds_port %>/v1/<% $.osds_tenant_id %>/jobs/<% $.jobId %>"
                    osds_token: '<% $.osds_token %>'
                publish:
                    print_status : <% task(get_bucket_migration).result.stdout %>
