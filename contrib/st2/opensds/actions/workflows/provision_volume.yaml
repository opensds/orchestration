version: "2.0"
name: "opensds.provision-volume"

workflows:

    main:
        type: direct
        input:
            - osds_ip
            - osds_port
            - osds_tenant_id
            - name
            - description
            - availability_zone
            - size
            - osds_profile_id
            - snapshot_id
            - snapshot_from_cloud
            - mount_point
            - host_info
            - connection_info
            - access_protocol
            - osds_token
            - timeout
        output:
            tagline: "<% $.print_status %>"
        task-defaults:
          on-error:
            - fail
        tasks:
            create_volume:
                action: opensds.create-volume
                input:
                    osds_ip: "<% $.osds_ip %>"
                    osds_port: "<% $.osds_port %>"
                    osds_tenant_id: "<% $.osds_tenant_id %>"
                    name: "<% $.name %>"
                    description: "<% $.description %>"
                    availability_zone: "<% $.availability_zone %>"
                    size: '<% $.size %>'
                    osds_profile_id: "<% $.osds_profile_id %>"
                    snapshot_id: "<% $.snapshot_id %>"
                    snapshot_from_cloud: '<% $.snapshot_from_cloud %>'
                    osds_token: "<% $.osds_token %>"
                publish:
                   volume_id: <% task(create_volume).result.result %>
                on-success:
                    - attach_volume
            attach_volume:
                action: opensds.attach-volume
                input:
                    osds_ip: "<% $.osds_ip %>"
                    osds_port: "<% $.osds_port %>"
                    osds_tenant_id: "<% $.osds_tenant_id %>"
                    volume_id: <% $.volume_id %>
                    mount_point: <% $.mount_point %>
                    host_info: <% $.host_info %>
                    connection_info: <% $.connection_info %>
                    access_protocol: <% $.access_protocol %>
                    osds_token: "<% $.osds_token %>"
                publish:
                    print_status : <% task(attach_volume).result.stdout %>
